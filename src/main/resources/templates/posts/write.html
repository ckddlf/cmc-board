<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}">
<head>
    <title>글쓰기 - CMC Board</title>
</head>

<body>
<div layout:fragment="content">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="form-card">
                    <div class="form-header">
                        <h2 class="form-title">
                            <i class="bi bi-pencil-square me-3"></i>새 글 작성
                        </h2>
                        <p class="form-subtitle">여러분의 이야기를 공유해주세요</p>
                    </div>

                    <form id="postForm" onsubmit="submitPost(event)">
                        <!-- 카테고리 선택 -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="bi bi-tags me-2"></i>카테고리
                                <span class="text-danger">*</span>
                            </label>
                            <div class="category-selector">
                                <div class="form-check form-check-inline" 
                                     th:each="category : ${categories}">
                                    <input class="form-check-input category-checkbox" 
                                           type="checkbox" 
                                           th:id="'category-' + ${category.id}"
                                           th:value="${category.id}"
                                           name="categoryIds">
                                    <label class="form-check-label category-label" 
                                           th:for="'category-' + ${category.id}"
                                           th:text="${category.name}">
                                        카테고리
                                    </label>
                                </div>
                            </div>
                            <small class="form-text text-muted">
                                최소 1개 이상의 카테고리를 선택해주세요.
                            </small>
                        </div>

                        <!-- 제목 -->
                        <div class="mb-4">
                            <label for="title" class="form-label">
                                <i class="bi bi-file-text me-2"></i>제목
                                <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   class="form-control form-control-lg" 
                                   id="title" 
                                   name="title"
                                   placeholder="제목을 입력하세요"
                                   maxlength="200"
                                   required>
                            <div class="character-count mt-2">
                                <span id="titleCount">0</span> / 200
                            </div>
                        </div>

                        <!-- 내용 -->
                        <div class="mb-4">
                            <label for="content" class="form-label">
                                <i class="bi bi-card-text me-2"></i>내용
                                <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control content-editor" 
                                      id="content" 
                                      name="content"
                                      rows="15" 
                                      placeholder="내용을 입력하세요"
                                      maxlength="10000"
                                      required></textarea>
                            <div class="character-count mt-2">
                                <span id="contentCount">0</span> / 10,000
                            </div>
                        </div>

                        <!-- 버튼 -->
                        <div class="form-actions">
                            <a href="/board" class="btn btn-outline-secondary btn-lg">
                                <i class="bi bi-x-circle me-2"></i>취소
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-circle me-2"></i>작성 완료
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="extra-js">
    <script>
        // 글자 수 카운터
        document.getElementById('title').addEventListener('input', function(e) {
            document.getElementById('titleCount').textContent = e.target.value.length;
        });

        document.getElementById('content').addEventListener('input', function(e) {
            document.getElementById('contentCount').textContent = e.target.value.length;
        });

        // 폼 제출
        function submitPost(event) {
            event.preventDefault();
            
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const categoryIds = Array.from(document.querySelectorAll('.category-checkbox:checked'))
                                     .map(cb => parseInt(cb.value));
            
            // 유효성 검증
            if (categoryIds.length === 0) {
                alert('최소 1개 이상의 카테고리를 선택해주세요.');
                return;
            }
            
            if (!title.trim()) {
                alert('제목을 입력해주세요.');
                return;
            }
            
            if (!content.trim()) {
                alert('내용을 입력해주세요.');
                return;
            }
            
            // API 호출
            fetch('/posts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: title,
                    content: content,
                    categoryIds: categoryIds
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.text();
                } else {
                    throw new Error('게시글 작성에 실패했습니다.');
                }
            })
            .then(postId => {
                alert('게시글이 작성되었습니다.');
                window.location.href = `/board/${postId}`;
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message);
            });
        }

        // 카테고리 체크박스 스타일 토글
        document.querySelectorAll('.category-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const label = this.nextElementSibling;
                if (this.checked) {
                    label.classList.add('active');
                } else {
                    label.classList.remove('active');
                }
            });
        });
    </script>
</th:block>
</body>
</html>