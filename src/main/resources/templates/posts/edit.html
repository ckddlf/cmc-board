<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}">
<head>
    <title>글 수정 - CMC Board</title>
</head>

<body>
<div layout:fragment="content">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="form-card">
                    <div class="form-header">
                        <h2 class="form-title">
                            <i class="bi bi-pencil-square me-3"></i>글 수정
                        </h2>
                        <p class="form-subtitle">게시글을 수정하세요</p>
                    </div>

                    <form id="postForm" onsubmit="updatePost(event)">
                        <input type="hidden" th:value="${post.id}" id="postId">
                        
                        <!-- 카테고리 선택 -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="bi bi-tags me-2"></i>카테고리
                                <span class="text-danger">*</span>
                            </label>
                            <div class="category-selector">
                                <div class="form-check form-check-inline" 
                                     th:each="category : ${categories}">
                                    <input class="form-check-input category-checkbox" 
                                           type="checkbox" 
                                           th:id="'category-' + ${category.id}"
                                           th:value="${category.id}"
                                           th:checked="${post.categories.contains(category)}"
                                           name="categoryIds">
                                    <label class="form-check-label category-label" 
                                           th:for="'category-' + ${category.id}"
                                           th:class="${post.categories.contains(category)} ? 'active' : ''"
                                           th:text="${category.name}">
                                        카테고리
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 제목 -->
                        <div class="mb-4">
                            <label for="title" class="form-label">
                                <i class="bi bi-file-text me-2"></i>제목
                                <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   class="form-control form-control-lg" 
                                   id="title" 
                                   name="title"
                                   th:value="${post.title}"
                                   placeholder="제목을 입력하세요"
                                   maxlength="200"
                                   required>
                            <div class="character-count mt-2">
                                <span id="titleCount" th:text="${#strings.length(post.title)}">0</span> / 200
                            </div>
                        </div>

                        <!-- 내용 -->
                        <div class="mb-4">
                            <label for="content" class="form-label">
                                <i class="bi bi-card-text me-2"></i>내용
                                <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control content-editor" 
                                      id="content" 
                                      name="content"
                                      rows="15" 
                                      placeholder="내용을 입력하세요"
                                      maxlength="10000"
                                      required
                                      th:text="${post.content}"></textarea>
                            <div class="character-count mt-2">
                                <span id="contentCount" th:text="${#strings.length(post.content)}">0</span> / 10,000
                            </div>
                        </div>

                        <!-- 버튼 -->
                        <div class="form-actions">
                            <a th:href="@{/board/{id}(id=${post.id})}" 
                               class="btn btn-outline-secondary btn-lg">
                                <i class="bi bi-x-circle me-2"></i>취소
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-circle me-2"></i>수정 완료
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="extra-js">
    <script th:inline="javascript">
        const postId = /*[[${post.id}]]*/ 1;
        
        // 글자 수 카운터
        document.getElementById('title').addEventListener('input', function(e) {
            document.getElementById('titleCount').textContent = e.target.value.length;
        });

        document.getElementById('content').addEventListener('input', function(e) {
            document.getElementById('contentCount').textContent = e.target.value.length;
        });

        // 폼 제출
        function updatePost(event) {
            event.preventDefault();
            
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const categoryIds = Array.from(document.querySelectorAll('.category-checkbox:checked'))
                                     .map(cb => parseInt(cb.value));
            
            // 유효성 검증
            if (categoryIds.length === 0) {
                alert('최소 1개 이상의 카테고리를 선택해주세요.');
                return;
            }
            
            // API 호출
            fetch(`/posts/${postId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: title,
                    content: content,
                    categoryIds: categoryIds
                })
            })
            .then(response => {
                if (response.ok) {
                    alert('게시글이 수정되었습니다.');
                    window.location.href = `/board/${postId}`;
                } else {
                    throw new Error('게시글 수정에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message);
            });
        }

        // 카테고리 체크박스 스타일 토글
        document.querySelectorAll('.category-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const label = this.nextElementSibling;
                if (this.checked) {
                    label.classList.add('active');
                } else {
                    label.classList.remove('active');
                }
            });
        });
    </script>
</th:block>
</body>
</html>